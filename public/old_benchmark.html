<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Benchmark Runner</title>
  <style>
    html, body { height: 100%; margin: 0; }
    iframe { width: 100%; height: 100%; border: 0; }
  </style>
</head>
<body>
  <script>
    (async function () {
      const params = new URLSearchParams(location.search);
      const site  = params.get("site")  || "about:blank";
      const runId = Number(params.get("runId") || Date.now());
      const index = Number(params.get("index") || 0);

      // Begin measuring load time of the external page by loading it in an iframe
      const start = performance.now();
      const iframe = document.createElement("iframe");
      iframe.src = site;
      document.body.appendChild(iframe);

      // When the iframe finishes loading, we have the real load time
      iframe.onload = async () => {
        const loadTime = performance.now() - start;

        // CPU test: simple math loop
        const cpuStart = performance.now();
        for (let i = 0; i < 1e7; i++) { Math.sqrt(i); }
        const cpuTime = performance.now() - cpuStart;

        // Network latency: attempt a fetch to the same site (no-cors still yields timing)
        const netStart = performance.now();
        try {
          await fetch(site, { mode: "no-cors", cache: "no-store" });
        } catch (e) { /* ignore errors caused by CORS */ }
        const networkLatency = performance.now() - netStart;

        // Memory usage (Chrome only)
        let memoryUsage = 0;
        if (performance.memory && performance.memory.usedJSHeapSize) {
          memoryUsage = performance.memory.usedJSHeapSize / (1024 * 1024); // MB
        }

        // Post result back to opener
        if (window.opener && window.opener.postMessage) {
          window.opener.postMessage(
            {
              type: "benchmarkResult",
              runId,
              index,
              site,
              cpuTime,
              memoryUsage,
              networkLatency,
              loadTime
            },
            "*"
          );
        }

        // Close this tab shortly after reporting
        setTimeout(() => window.close(), 400);
      };
    })();
  </script>
</body>
</html>
